用户服务
**功能：**
- 注册
- 用户登录与认证
- 生成唯一 ID 及后续修改
- 用户资料的设置与更新（包括显示唯一 ID）

### 功能概述
本用户服务主要包含以下核心功能：
- **用户注册**：用户可使用手机号进行注册，并自动生成唯一 ID。
- **用户认证**：支持手机号+密码登录，并提供账户安全机制。
- **唯一 ID 生成与修改**：用户注册时生成唯一 ID，并支持每日一次修改。
- **用户资料管理**：用户可设置昵称、个性签名等个人信息，并进行更新。
- **设备管理**：记录用户的登录设备，支持设备识别与管理。
- **行为分析与风控**：收集用户操作日志，分析异常行为，限制恶意操作。

**职责：**
管理用户的基本信息和认证，负责用户注册、登录以及资料变更。

1. **注册**
   - **手机号校验**：用户提交手机号后，系统检查是否已注册，并验证手机号格式是否正确。
   - **唯一 ID 生成**：系统为每个新用户生成唯一的 `unique_id`，该 ID 可用于用户标识和后续更新操作。
   - **设备注册限制**：通过设备标识（如 UUID、浏览器指纹）限制每个设备每天最多可创建 3 个账户，以防止滥用。
   - **注册成功**：成功注册后，用户直接使用手机号/unique_id+密码进行登录。

2. **用户认证**
   - **身份验证**：登录时校验用户提交的凭据（密码），确保其真实性。
   - **Token 生成与管理**：成功登录后，系统返回访问令牌（JWT），用于后续请求的身份验证。
   - **安全策略**：
     - 增加失败登录次数上限（5 次失败后限制登录一段时间）。

3. **唯一 ID 生成及修改**
   - **初始生成**：用户注册成功时，系统会自动分配唯一 ID (`unique_id`)。
   - **修改规则**：
     - **限制修改次数**：每天只能改一次。
     - 记录修改历史
   - **存储与索引**：`unique_id` 需在数据库中建立索引，确保查询效率。

4. **用户资料的设置与更新**
   - **基础信息**：用户可以设置昵称、个性签名等个人资料。
   - **更新流程**：
     - **数据校验**：检查输入数据格式，避免恶意输入。
   - **安全策略**：
     - **日志记录**：记录用户修改资料的历史记录，以便溯源。

5. **设备标识**
   - **获取方式**：
     - **移动端**：Android 使用 `ANDROID_ID`，iOS 使用 `identifierForVendor (IDFV)`。
     - **Web 端**：使用浏览器指纹（如 `fingerprint.js`）或 LocalStorage 生成设备唯一标识。
   - **用途**：
     - **注册限制**：每个设备每天最多可创建 3 个账户，防止恶意注册。
     - **登录管理**：记录用户的设备信息，支持设备登录历史管理。

6. **行为分析**
   - **收集数据**：
     - 记录用户的关键行为（如登录、资料修改）。
     - 关联设备 ID、IP 地址等信息，以进行风险评估。
   - **异常检测**：
     - 通过行为模式分析检测异常，如短时间内多次创建账户。（创建账户限制为每设备每天 3 次）
   - **风控措施**：
     - 限制异常用户的部分权限，如降低发送消息的频率。

### 用户登录
登录功能用于验证用户身份，支持以下方式：
1. **手机号+密码**：用户输入手机号和密码进行验证。

**登录流程：**
- 用户提交登录信息（手机号+密码）。可以使用uniqueid
- 系统验证手机号是否存在，并校验密码的正确性。
- 登录成功后，生成访问令牌（Token）并返回给用户，用于后续 API 请求鉴权。
- 记录用户登录信息，包括 IP 地址、设备标识等，以便进行安全分析。

**安全措施：**
- **密码加密存储**：使用 `bcrypt` 或 `argon2` 进行加密存储，防止泄露。
- **异常检测**：如检测到异常登录行为5次失败，等5分钟。

用户资料

### 用户个人资料
用户个人资料存储在 `user_profiles` 表中，包含以下字段：
- `user_id` (BIGINT) - 关联用户 ID。
- `nickname` (VARCHAR) - 用户昵称。
- `bio` (TEXT) - 个人简介。
- `gender` (TINYINT) - 性别（0：未知，1：男，2：女）。
- `birthday` (DATE) - 生日。
- `location` (VARCHAR) - 位置，如国家/城市信息。
- `website` (VARCHAR) - 个人网站或社交媒体链接。
- `created_at` (TIMESTAMP) - 记录创建时间。
- `updated_at` (TIMESTAMP) - 记录更新时间。

**更新规则：**
- `nickname` 不能为空，且长度限制为 2~30 个字符。
- `bio` 可选，但长度不超过 200 字符。
- `gender` 默认为 0，可选 1（男）或 2（女）。
- `birthday` 格式为 YYYY-MM-DD，不可设置未来日期。
- `location` 可选，支持用户填写国家或城市。
- `website` 可选，但必须是有效的 URL 格式。
- **日志记录**：所有更新操作都会记录日志，以便溯源。

---
### 数据库表设计

为了支持用户服务的功能，数据库需要至少包含以下几个表：

1. **users（用户表）**
   - `id` (BIGINT, 主键，自增)
   - `phone` (VARCHAR, 唯一，用户注册手机号)
   - `unique_id` (VARCHAR, 唯一，用户唯一 ID)
   - `password_hash` (VARCHAR, 存储加密后的密码)
   - `failed_attempts` (INT, 记录连续失败的登录尝试次数)
   - `locked_until` (TIMESTAMP NULL, 账户锁定到期时间, 仅在被锁定时有效)
   - `created_at` (TIMESTAMP, 记录创建时间)
   - `updated_at` (TIMESTAMP, 记录更新时间)

2. **user_profiles（用户资料表）**
   - `user_id` (BIGINT, 外键，关联 `users.id`)
   - `nickname` (VARCHAR, 用户昵称)
   - `bio` (TEXT, 个人简介)
   - `created_at` (TIMESTAMP)
   - `updated_at` (TIMESTAMP)

3. **user_devices（用户设备表）**
   - `id` (BIGINT, 主键)
   - `user_id` (BIGINT, 外键，关联 `users.id`)
   - `device_id` (VARCHAR, 设备唯一标识符)
   - `created_at` (TIMESTAMP)

4. **user_behavior_logs（用户行为日志表）**
   - `id` (BIGINT, 主键)
   - `user_id` (BIGINT, 外键，关联 `users.id`)
   - `action` (VARCHAR, 用户执行的行为)
   - `metadata` (JSON, 记录行为的相关数据)
   - `created_at` (TIMESTAMP)

5. **message_limits（用户消息限制表）**
   - `id` (BIGINT, 主键)
   - `user_id` (BIGINT, 外键，关联 `users.id`)
   - `device_id` (VARCHAR, 设备唯一标识符, 关联 `user_devices.device_id`)
   - `message_count` (INT, 记录用户当日发送的消息数量)
   - `last_reset` (TIMESTAMP, 记录计数器上次重置时间)